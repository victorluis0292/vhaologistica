<div th:fragment="contenido">

    <h3 class="mb-3">AdministraciÃ³n de Coordinadores</h3>

    <!-- BOTÃ“N PARA ABRIR MODAL -->
    <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#modalUsuario" onclick="nuevoUsuario()">
        âž• Agregar Coordinador
    </button>

  
<!-- ðŸ” BUSCADOR PREDICTIVO -->
<div class="card p-3 mb-4 shadow-sm position-relative">

    <h5 class="mb-3">Buscar Coordinadores</h5>
      <input  type="text"
        id="buscador"
        class="form-control"
        placeholder="Buscar por nombre, correo o rol..."
        onkeyup="predictivo()"

        autocomplete="off"
        autocorrect="off"
        autocapitalize="off"
        spellcheck="false"
        role="presentation"
        name="no-save-field">


    <!-- Caja de sugerencias -->
   <ul id="sugerencias"
    class="list-group w-100 mt-1"
    style="display:none; max-height: 200px; overflow-y:auto;">
</ul>


</div>



    <!-- TABLA -->
    <table class="table table-bordered mt-3" id="tabla">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Correo</th>
                <th>Estado</th>
                <th>Ciudad</th>
                <th>Rol</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="tablaBody"></tbody>
    </table>


    <!-- ====================================================== -->
    <!-- ðŸš€ MODAL DEL FORMULARIO -->
    <!-- ====================================================== -->
    <div class="modal fade" id="modalUsuario" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Formulario de Coordinador</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <form id="formUsuario">

                        <input type="hidden" id="id"/>

                        <div class="row mb-3">
                            <div class="col">
                                <label>Nombre:</label>
                                <input id="nombre" class="form-control" required />
                            </div>
                            <div class="col">
                                <label>Correo:</label>
                                <input id="correo" class="form-control" required />
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col">
                                <label>Password:</label>
                                <input id="pass" type="password" class="form-control" required />
                            </div>
                            <div class="col">
                                <label>Rol:</label>
                                <select id="rol" class="form-control">
                                    <option value="coordinador">Coordinador</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col">
                                <label>Estado:</label>
                                <input id="estado" class="form-control" />
                            </div>
                            <div class="col">
                                <label>Ciudad:</label>
                                <input id="ciudad" class="form-control" />
                            </div>
                        </div>

                    </form>

                </div>

                <div class="modal-footer">
                    <button class="btn btn-success" onclick="guardarUsuario()">Guardar</button>
                    <button class="btn btn-secondary" onclick="limpiar()">Limpiar</button>
                </div>

            </div>
        </div>
    </div>



    <!-- ====================================================== -->
    <!--   JAVASCRIPT                                           -->
    <!-- ====================================================== -->
    <script>

    let usuarios = [];

    // Cargar todos al iniciar
    cargar();

    function cargar() {
        fetch('/api/usuarios')
            .then(r => r.json())
            .then(data => {
                usuarios = data;
                mostrar(data);
            });
    }

    function mostrar(lista) {
        let html = "";
        lista.forEach(u => {
            html += `
            <tr>
                <td>${u.nombre}</td>
                <td>${u.correo}</td>
                <td>${u.estado ?? ''}</td>
                <td>${u.ciudad ?? ''}</td>
                <td>${u.rol}</td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick="editar(${u.id})">Editar</button>
                    <button class="btn btn-danger btn-sm" onclick="eliminar(${u.id})">Eliminar</button>
                </td>
            </tr>`;
        });
        document.getElementById("tablaBody").innerHTML = html;
    }

    // Abrir modal vacÃ­o
    function nuevoUsuario() {
        limpiar();
    }

    // Abrir modal con datos cargados
    function editar(id) {
        let u = usuarios.find(x => x.id === id);
        if (!u) return;

        document.getElementById("id").value = u.id;
        document.getElementById("nombre").value = u.nombre;
        document.getElementById("correo").value = u.correo;
        document.getElementById("pass").value = u.pass;
        document.getElementById("estado").value = u.estado;
        document.getElementById("ciudad").value = u.ciudad;
        document.getElementById("rol").value = u.rol;

        new bootstrap.Modal(document.getElementById('modalUsuario')).show();
    }

    function eliminar(id) {
        if (!confirm("Â¿Eliminar usuario?")) return;

        fetch(`/api/usuarios/${id}`, { method: 'DELETE' })
            .then(() => cargar());
    }

    function limpiar() {
        document.getElementById("formUsuario").reset();
        document.getElementById("id").value = "";
    }

    // Guardar o actualizar
    function guardarUsuario() {
        let id = document.getElementById("id").value;

        let data = {
            nombre: nombre.value,
            correo: correo.value,
            pass: pass.value,
            estado: estado.value,
            ciudad: ciudad.value,
            rol: rol.value
        };

        let url = "/api/usuarios";
        let method = "POST";

        if (id) {
            url += "/" + id;
            method = "PUT";
        }

        fetch(url, {
            method: method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        }).then(() => {
            limpiar();
            cargar();
            bootstrap.Modal.getInstance(document.getElementById('modalUsuario')).hide();
        });
    }

    // ðŸ” FILTRAR (botÃ³n Buscar)
    function filtrar() {
        let q = document.getElementById("buscador").value.trim();

        fetch(`/api/usuarios/buscar?q=${encodeURIComponent(q)}`)
            .then(r => r.json())
            .then(data => {
                mostrar(data);

                // al filtrar ocultamos sugerencias
                document.getElementById("sugerencias").style.display = "none";
            });
    }

    // ðŸ” BUSCADOR PREDICTIVO
function predictivo() {

    let q = document.getElementById("buscador").value.trim();
    let caja = document.getElementById("sugerencias");
    indiceSeleccionado = -1; // Reset de selecciÃ³n

    if (q.length === 0) {
        caja.style.display = "none";
        cargar(); // vuelve todo a la normalidad
        return;
    }

    fetch(`/api/usuarios/buscar?q=${encodeURIComponent(q)}`)
        .then(r => r.json())
        .then(data => {

            // ðŸ”¥ ACTUALIZA LA TABLA MIENTRAS ESCRIBES
            mostrar(data);

            caja.innerHTML = "";

            if (data.length === 0) {
                caja.style.display = "none";
                return;
            }

            caja.style.display = "block";

            data.forEach(u => {
                let li = document.createElement("li");
                li.className = "list-group-item list-group-item-action";
                li.innerHTML = `
                    <strong>${u.nombre}</strong><br>
                    <small>${u.correo}</small>
                `;

                li.onclick = () => {
                    document.getElementById("buscador").value = u.nombre;
                    caja.style.display = "none";
                    filtrar(); // busca exacto cuando seleccionas
                };

                caja.appendChild(li);
            });
        });
}
function seleccionarSugerencia(u) {
    document.getElementById("buscador").value = u.nombre;
    document.getElementById("sugerencias").style.display = "none";
    filtrar();
}




</script>


</div>
